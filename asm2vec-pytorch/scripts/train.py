# Copyright (c) 2021 oalieno

import torch
import click

import sys
sys.path.append('./asm2vec/')
import datatype
import model
import utils

"""
@click.command()
@click.option('-i', '--input', 'ipath', help='training data folder', required=True)
@click.option('-o', '--output', 'opath', default='model.pt', help='output model path', show_default=True)
@click.option('-m', '--model', 'mpath', help='load previous trained model path', type=str)
@click.option('-l', '--limit', help='limit the number of functions to be loaded', show_default=True, type=int)
@click.option('-d', '--ebedding-dimension', 'embedding_size', default=100, help='embedding dimension', show_default=True)
@click.option('-b', '--batch-size', 'batch_size', default=1024, help='batch size', show_default=True)
@click.option('-e', '--epochs', default=10, help='training epochs', show_default=True)
@click.option('-n', '--neg-sample-num', 'neg_sample_num', default=25, help='negative sampling amount', show_default=True)
@click.option('-a', '--calculate-accuracy', 'calc_acc', help='whether calculate accuracy ( will be significantly slower )', is_flag=True)
@click.option('-c', '--device', default='auto', help='hardware device to be used: cpu / cuda / auto', show_default=True)
@click.option('-lr', '--learning-rate', 'lr', default=0.02, help="learning rate", show_default=True)
"""

def cli(ipath, opath, mpath, limit, embedding_size=100, batch_size=1024, epochs=10, neg_sample_num=25, calc_acc=False, device='auto', lr=0.02):
    if device == 'auto':
        device = 'cuda' if torch.cuda.is_available() else 'cpu'
    
    if mpath:
        model, tokens = utils.load_model(mpath, device=device)
        functions, tokens_new = utils.load_data(ipath, limit=limit)
        tokens.update(tokens_new)
        model.update(len(functions), tokens.size())
    else:
        model = None
        functions, tokens, offset = utils.load_data(ipath, limit=limit)

    def callback(context):
        progress = f'{context["epoch"]} | time = {context["time"]:.2f}, loss = {context["loss"]:.4f}'
        if context["accuracy"]:
            progress += f', accuracy = {context["accuracy"]:.4f}'
        print(progress)
        utils.save_model(opath, context["model"], context["tokens"])

    model = utils.train(
        functions,
        tokens,
        model=model,
        embedding_size=embedding_size,
        batch_size=batch_size,
        epochs=epochs,
        neg_sample_num=neg_sample_num,
        calc_acc=calc_acc,
        device=device,
        callback=callback,
        learning_rate=lr
    )

if __name__ == '__main__':
    ipath = 'test_asm/'
    opath = 'temp_model.pt'
    cli(ipath=ipath, opath=opath, mpath=None, limit=None)
