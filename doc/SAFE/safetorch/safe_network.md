# SAFE Network Module Documentation

## Overview

The `safe_network.py` file implements the SAFE (Self-Attentive Function Embeddings) model, a neural network architecture designed for learning function embeddings from binary code. This model is based on the work presented in the paper "SAFE: Self-Attentive Function Embeddings for Binary Similarity" by Massarelli et al. (2019).

## Class: SAFE

```python
class SAFE(nn.Module):
```

This class implements the SAFE model architecture.

### Architecture Overview

1. Instruction Embedding Layer
2. Bidirectional GRU (Gated Recurrent Unit)
3. Self-Attention Mechanism
4. Dense Layers for Final Embedding Generation

### Initialization

```python
def __init__(self, config):
```

#### Parameters:
- `config` (Config): Configuration object containing model hyperparameters

### Key Components

1. **Instruction Embeddings**: 
   ```python
   self.instructions_embeddings = torch.nn.Embedding(
       self.conf.num_embeddings, self.conf.embedding_size
   )
   ```

2. **Bidirectional GRU**:
   ```python
   self.bidirectional_rnn = torch.nn.GRU(
       input_size=self.conf.embedding_size,
       hidden_size=self.conf.rnn_state_size,
       num_layers=self.conf.rnn_depth,
       bidirectional=True,
       # ... other parameters ...
   )
   ```

3. **Self-Attention Weights**:
   ```python
   self.WS1 = Parameter(torch.Tensor(self.conf.attention_depth, 2 * self.conf.rnn_state_size))
   self.WS2 = Parameter(torch.Tensor(self.conf.attention_hops, self.conf.attention_depth))
   ```

4. **Dense Layers**:
   ```python
   self.dense_1 = torch.nn.Linear(
       2 * self.conf.attention_hops * self.conf.rnn_state_size,
       self.conf.dense_layer_size
   )
   self.dense_2 = torch.nn.Linear(
       self.conf.dense_layer_size, self.conf.embedding_size
   )
   ```

### Forward Pass

```python
def forward(self, instructions, lengths):
```

#### Parameters:
- `instructions` (torch.Tensor): Tensor of instruction indices
- `lengths` (torch.Tensor): Tensor of valid instruction lengths for each function

#### Returns:
- `function_embedding` (torch.Tensor): The final embedding for the input function

#### Process:
1. Embed instructions
2. Process through bidirectional GRU
3. Apply self-attention mechanism
4. Generate final embedding through dense layers

## Usage

To use the SAFE model in your project:

```python
from parameters import Config
from safe_network import SAFE

# Initialize configuration
config = Config()

# Create model
model = SAFE(config)

# Forward pass
instructions = torch.LongTensor([...])  # Your instruction indices
lengths = torch.LongTensor([...])  # Valid lengths of instructions
embedding = model(instructions, lengths)
```

This model is designed to process binary code functions and produce fixed-size embeddings that capture semantic information, useful for tasks like binary similarity analysis and malware detection.
