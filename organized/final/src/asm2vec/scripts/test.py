# Copyright (c) 2021 oalieno

import torch
from ..package import utils

def cli(ipath, mpath, epochs=30, neg_sample_num=25, device='auto', lr=0.02, pretty=False, limit=None):
    """
    ASM2VEC inference and embedding extraction.

    Args:
        ipath (str): Path to the input assembly data.
        mpath (str): Path to the pre-trained model.
        epochs (int): Number of fine-tuning epochs.
        neg_sample_num (int): Number of negative samples for training.
        device (str): Device to use for computation ('auto', 'cuda', or 'cpu').
        lr (float): Learning rate for fine-tuning.
        pretty (bool): Whether to use pretty formatting for output.
        limit (int): Limit on the number of samples to process.

    Returns:
        tuple: Contains the offset and the extracted embedding.
    """
    if device == 'auto':
        device = 'cuda' if torch.cuda.is_available() else 'cpu'

    # load model, tokens
    model, tokens = utils.load_model(mpath, device=device)
    functions, tokens_new, offset = utils.load_data(ipath)
    tokens.update(tokens_new)
    model.update(1, tokens.size())
    model = model.to(device)

    # train function embedding
    model = utils.train(
        functions,
        tokens,
        model=model,
        epochs=epochs,
        neg_sample_num=neg_sample_num,
        device=device,
        mode='test',
        learning_rate=lr
    )

    # show predicted probability results
    x, y = utils.preprocess(functions, tokens)

    # get the final embedding of the input file
    embedding = model.get_embedding(x.to(device)) # the dim of the embedding is (embedding_size,)
    embedding = embedding.detach().cpu().numpy()
            
    return offset, embedding
