# create GCN model, MalwareExpert
# linear, graphConv, deeperGCN*n(7), normalization, activation, 
# global mean pooling, dropout, linear, softmax
# deeperGCN: normalization, activation, dropout, graphConv
# use the feature matrix and edge_index(2*num_edge) matrix as input
# use the label as output

import torch.nn as nn
from gnn.layer import deeperGCN
from torch_geometric.nn import GCNConv
from malwareDetector.config import read_config
from torch_geometric.nn import global_mean_pool

class MalwareExpertModel(nn.Module):
    def __init__(self, input_dim: int, hidden_dim: int, config=None):
        super(MalwareExpertModel, self).__init__()
        self.config = config
        self.linear1 = nn.Linear(input_dim, hidden_dim)
        self.graphConv = GCNConv(hidden_dim, hidden_dim)
        self.deeperGCN1 = deeperGCN(hidden_dim, hidden_dim, self.config.model.dropout_value)
        self.deeperGCN2 = deeperGCN(hidden_dim, hidden_dim, self.config.model.dropout_value)
        self.deeperGCN3 = deeperGCN(hidden_dim, hidden_dim, self.config.model.dropout_value)
        self.deeperGCN4 = deeperGCN(hidden_dim, hidden_dim, self.config.model.dropout_value)
        self.deeperGCN5 = deeperGCN(hidden_dim, hidden_dim, self.config.model.dropout_value)
        self.deeperGCN6 = deeperGCN(hidden_dim, hidden_dim, self.config.model.dropout_value)
        self.deeperGCN7 = deeperGCN(hidden_dim, hidden_dim, self.config.model.dropout_value)
        self.norm = nn.LayerNorm(hidden_dim)
        self.activation = nn.ReLU()
        self.global_mean_pool = global_mean_pool
        self.dropout = nn.Dropout(self.config.model.dropout_value)
        self.linear2 = nn.Linear(hidden_dim, self.config.model.output_dim)
        self.softmax = nn.Softmax(dim=self.config.model.softmax_dim)

    def forward(self, x, edge_index, data):
        x = self.linear1(x)
        x = self.graphConv(x, edge_index)
        x = self.deeperGCN1(x, edge_index)
        x = self.deeperGCN2(x, edge_index)
        x = self.deeperGCN3(x, edge_index)
        x = self.deeperGCN4(x, edge_index)
        x = self.deeperGCN5(x, edge_index)
        x = self.deeperGCN6(x, edge_index)
        x = self.deeperGCN7(x, edge_index)
        x = self.norm(x)
        x = self.activation(x)
        x = self.global_mean_pool(x, data.batch)
        x = self.dropout(x)
        x = self.linear2(x)
        x = self.softmax(x)
        return x
